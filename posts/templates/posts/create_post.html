{% extends "base.html" %}

{% block title %}
Mindlink - Create New Post
{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'posts/css/style.css' %}">
<style>
.form-container {
  max-width: 1000px;
  margin: 0 auto;
  text-align: left;
}

.form-group label {
  font-weight: 600;
  display: block;
  margin-bottom: 6px;
}

.form-control {
  width: 100%;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 1rem;
}

/* CKEditor full width */
.cke_contents, .cke { width: 100% !important; }

/* Mic Button */
#mic-button {
  display: inline-block;
  margin: 15px 0;
  padding: 10px 20px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.3s ease;
  background-color: #6c757d;
  color: white;
  border: none;
  cursor: pointer;
}

#mic-button.btn-listening {
  background-color: #ff4757;
  color: white;
  box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.word-count-display {
  margin-top: 15px;
  padding: 12px 20px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 8px;
  font-size: 14px;
  color: white;
  width: fit-content; 
  display: flex; 
  gap: 30px;
  align-items: center;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.word-count-display .count-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.unsaved-warning {
  display: none;
  color: #ff6b6b;
  font-size: 0.9em;
  margin-top: 10px;
}

.unsaved-warning.show {
  display: block;
}

.mood-question {
  margin-bottom: 20px;
}

#emojiOptions {
  display: flex;
  gap: 20px;
  margin-top: 8px;
}

.emoji-option {
  font-size: 2rem;
  cursor: pointer;
  padding: 10px;
  border-radius: 10px;
  transition: all 0.25s ease;
  user-select: none;
}

.emoji-option:hover {
  transform: scale(1.15);
  background-color: #f3f4f6;
}

.emoji-selected {
  background-color: #e0e7ff;
  border: 2px solid #4e73df;
  transform: scale(1.2);
  box-shadow: 0 2px 6px rgba(78, 115, 223, 0.3);
}
</style>
{% endblock %}

{% block content %}
<section class="new-post">
  <div class="container">
    <div class="section-title">
      <h2>Create New Post</h2>
      <p>Share your thoughts and experiences.</p>
    </div>

    <div class="form-container">
      <form method="post" id="journalForm">
        {% csrf_token %}

        <div class="form-group" style="margin-bottom: 20px;">
          <label for="postType">Which type of post do you want to enter?</label>
          <select name="post_type" id="postType" class="form-control" required>
            <option value="" disabled selected>-- Select post type --</option>
            <option value="daily">Daily</option>
            <option value="mood">Mood</option>
          </select>
        </div>

        <div id="dynamicFields"></div>

        <p id="unsavedWarning" class="unsaved-warning">
          <i class="fas fa-exclamation-triangle"></i> You have unsaved changes.
        </p>

        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
          <i class="fas fa-paper-plane"></i> Publish
        </button>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
{{ form.media }}  <!-- CKEditor JS assets -->

<script>
let hasUnsavedChanges = false;
let editorInstance = null;

// Initialize CKEditor safely for dynamic textareas
function setupCKEditor(textareaId) {
  if (typeof CKEDITOR === 'undefined') return;

  if (CKEDITOR.instances[textareaId]) CKEDITOR.instances[textareaId].destroy(true);
  CKEDITOR.replace(textareaId);

  CKEDITOR.instances[textareaId].on('instanceReady', function(evt) {
    editorInstance = evt.editor;

    const updateWordCount = () => {
      const content = editorInstance.getData();
      const stripped = content.replace(/<[^>]*>/g, '').trim();
      const words = stripped.split(/\s+/).filter(w=>w.length>0).length;
      const chars = stripped.length;
      document.getElementById('wordCount').textContent = words;
      document.getElementById('charCount').textContent = chars;
    };

    editorInstance.on('change', updateWordCount);
    editorInstance.on('key', () => setTimeout(updateWordCount, 10));
    editorInstance.on('paste', () => setTimeout(updateWordCount, 100));

    updateWordCount();
  });
}

// Mic / Speech-to-Text Setup
function setupMicButton() {
  const micButton = document.getElementById('mic-button');
  if (!micButton) return;

  if (window.SpeechRecognition || window.webkitSpeechRecognition) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = new SpeechRecognition();
    recognition.interimResults = false;
    recognition.continuous = false;
    recognition.lang = 'en-US';
    let isListening = false;

    recognition.onresult = (event) => {
      let finalTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; i++)
        if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;

      if (finalTranscript && editorInstance) {
        editorInstance.insertHtml(finalTranscript + ' ');
        editorInstance.fire('change');
      }
    };

    recognition.onstart = () => {
      micButton.textContent = 'Dictating... (Click to Stop)';
      micButton.classList.add('btn-listening');
      isListening = true;
    };

    recognition.onend = () => {
      micButton.innerHTML = '<i class="fas fa-microphone"></i> Start Voice Input';
      micButton.classList.remove('btn-listening');
      isListening = false;
    };

    micButton.addEventListener('click', () => {
      if (!editorInstance) return alert("Editor not ready.");
      isListening ? recognition.stop() : recognition.start();
    });
  } else {
    micButton.style.display = 'none';
  }
}

// Dynamic fields handling
const postTypeSelect = document.getElementById('postType');
const dynamicFields = document.getElementById('dynamicFields');

postTypeSelect.addEventListener('change', function() {
  const type = this.value;
  dynamicFields.innerHTML = '';

  if (type === 'mood') {
    dynamicFields.innerHTML = `
      <div class="mood-question">
        <label>1) What is your current mood?</label>
        <div id="emojiOptions">
          <span class="emoji-option" data-value="happy">üòä</span>
          <span class="emoji-option" data-value="neutral">üòê</span>
          <span class="emoji-option" data-value="sad">üòû</span>
        </div>
        <input type="hidden" name="mood_emoji" id="moodEmoji">
      </div>
      <div class="mood-question">
        <label>2) Energy level (1-5)</label>
        <input type="number" name="energy_level" min="1" max="5" class="form-control" required>
      </div>
      <div class="mood-question">
        <label>3) Did you work out today?</label>
        <select name="worked_out" class="form-control" required>
          <option value="" disabled selected>-- Select an option --</option>
          <option value="True">Yes</option>
          <option value="False">No</option>
        </select>
      </div>
      <div class="mood-question">
        <label>4) What triggered this mood?</label>
        <textarea name="mood_trigger" rows="3" class="form-control" required></textarea>
      </div>
    `;

    document.querySelectorAll('.emoji-option').forEach(el => {
      el.addEventListener('click', function() {
        document.querySelectorAll('.emoji-option').forEach(e=>e.classList.remove('emoji-selected'));
        this.classList.add('emoji-selected');
        document.getElementById('moodEmoji').value = this.dataset.value;
      });
    });

  } else if (type === 'daily') {
    dynamicFields.innerHTML = `
      <button type="button" id="mic-button"><i class="fas fa-microphone"></i> Start Voice Input</button>
      <div style="margin-bottom:10px">
        <textarea id="text" name="text"></textarea>
      </div>
      <div class="word-count-display">
        <div class="count-item"><i class="fas fa-font"></i> Words: <strong id="wordCount">0</strong></div>
        <div class="count-item"><i class="fas fa-keyboard"></i> Chars: <strong id="charCount">0</strong></div>
      </div>
    `;
    // Initialize CKEditor and mic after DOM insertion
    setupCKEditor('text');
    setupMicButton();
  }
});

// Unsaved changes warning
window.addEventListener('beforeunload', function(e) {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    return e.returnValue;
  }
});

document.getElementById('journalForm').addEventListener('submit', function() {
  hasUnsavedChanges = false;
});
</script>
{% endblock %}
