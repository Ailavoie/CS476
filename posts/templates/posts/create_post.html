{% extends "base.html" %}

{% block title %}
  Mindlink - Create New Post
{% endblock %}

{% block extra_css %}
  {% load static %}
  <link rel="stylesheet" href="{% static 'posts/css/style.css' %}">
  <style>
    /* Make editor container full width */
    .form-container {
      max-width: 1000px; /* Adjusted for better utilization */
      margin: 0 auto;
    }
    
    /* CRITICAL: Force CKEditor elements to use 100% of the container width */
    .cke_contents, .cke { 
      width: 100% !important;
    }
    
    /* Microphone Button Styling */
    #mic-button {
      margin-bottom: 20px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    /* Visual feedback when listening */
    #mic-button.btn-listening {
      background-color: #ff4757; /* Red color for recording */
      color: white;
      box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Word count styling */
    .word-count-display {
      margin-top: 15px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      font-size: 14px;
      color: white;
      width: fit-content; 
      display: flex; 
      gap: 30px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
    
    .word-count-display .count-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .unsaved-warning {
      display: none;
      color: #ff6b6b;
      font-size: 0.9em;
      margin-top: 10px;
    }
    .unsaved-warning.show {
      display: block;
    }
  </style>
{% endblock %}

{% block content %}
<section class="new-post">
  <div class="container">
    <div class="section-title">
      <h2>Create New Post</h2>
      <p>Share your thoughts and experiences.</p>
    </div>
    <div class="form-container">
      <form method="post" id="journalForm">
        {% csrf_token %}
        
        <button type="button" id="mic-button" class="btn btn-secondary">
            <i class="fas fa-microphone"></i> Start Voice Input
        </button>
        {{ form.as_p }}
        
        <div class="word-count-display">
            <div class="count-item">
                <i class="fas fa-font"></i>
                <span>Words: <strong id="wordCount">0</strong></span>
            </div>
            <div class="count-item">
                <i class="fas fa-keyboard"></i>
                <span>Chars: <strong id="charCount">0</strong></span>
            </div>
        </div>
        <p id="unsavedWarning" class="unsaved-warning">
            <i class="fas fa-exclamation-triangle"></i> You have unsaved changes.
        </p>
        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
          <i class="fas fa-paper-plane"></i> Publish
        </button>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
  {{ form.media }} 

  <script>
    // --- CKEDITOR WORD COUNT & UNSAVED CHANGES LOGIC (EXISTING) ---
    let hasUnsavedChanges = false;
    let editorInstance = null;

    if (typeof CKEDITOR !== 'undefined') {
      CKEDITOR.on('instanceReady', function(event) {
        editorInstance = event.editor;

        const updateWordCount = () => {
          const content = editorInstance.getData();
          const strippedContent = content.replace(/<[^>]*>/g, '').trim();
          const words = strippedContent.split(/\s+/).filter(word => word.length > 0).length;
          const chars = strippedContent.length;
          
          document.getElementById('wordCount').textContent = words;
          document.getElementById('charCount').textContent = chars;
        }
        
        // Event listeners for counting and unsaved changes
        editorInstance.on('change', function() {
          updateWordCount();
          hasUnsavedChanges = true;
          document.getElementById('unsavedWarning').classList.add('show');
        });
        
        editorInstance.on('key', function() {
          setTimeout(updateWordCount, 10);
        });
        
        editorInstance.on('paste', function() {
          setTimeout(updateWordCount, 100);
        });
        
        updateWordCount();
      });
      
      // ... Unsaved changes warning code (omitted for brevity, assume it's there)
      window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
          return e.returnValue;
        }
      });
      document.getElementById('journalForm').addEventListener('submit', function() {
        hasUnsavedChanges = false;
      });
    }

    // --- NEW SPEECH-TO-TEXT LOGIC ---
    const micButton = document.getElementById('mic-button');

    if (window.SpeechRecognition || window.webkitSpeechRecognition) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = new SpeechRecognition();
        
        // CRITICAL CHANGE: Set language to English (United States)
        recognition.interimResults = false;
        recognition.continuous = false;
        recognition.lang = 'en-US';        
        
        let isListening = false;
        
        recognition.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                }
            }
            
            if (finalTranscript && editorInstance) {
                // Insert transcribed text at the current cursor position in CKEditor
                editorInstance.insertHtml(finalTranscript + ' ');
                // Manually trigger a change event to update word count/unsaved status
                editorInstance.fire('change'); 
            }
        };

        recognition.onstart = () => {
            micButton.textContent = 'Dictating... (Click to Stop)';
            micButton.classList.add('btn-listening');
            isListening = true;
        };

        recognition.onend = () => {
            micButton.textContent = 'Start Voice Input';
            micButton.classList.remove('btn-listening');
            isListening = false;
        };

        micButton.addEventListener('click', () => {
            if (!editorInstance) {
                alert("The editor is not ready yet. Please wait a moment.");
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    // Start listening
                    recognition.start();
                } catch (e) {
                    console.error("Error starting recognition:", e);
                }
            }
        });

    } else {
        // Hide button if browser is not supported
        micButton.style.display = 'none';
    }
  </script>
{% endblock %}