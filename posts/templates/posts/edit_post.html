{% extends "base.html" %}

{% block title %}
Mindlink - Edit Post
{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="{% static 'posts/css/style.css' %}">
<style>
  .form-container {
    max-width: 1000px;
    margin: 0 auto;
    text-align: left;
  }

  .form-group label {
    font-weight: 600;
    display: block;
    margin-bottom: 6px;
  }

  .form-control {
    width: 100%;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }

  .cke_contents, .cke { width: 100% !important; }

  #mic-button {
    display: inline-block;
    margin: 15px 0;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    background-color: #6c757d;
    color: white;
    border: none;
    cursor: pointer;
  }

  #mic-button.btn-listening {
    background-color: #ff4757;
    color: white;
    box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .word-count-display {
    margin-top: 15px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 8px;
    font-size: 14px;
    color: white;
    width: fit-content; 
    display: flex; 
    gap: 30px;
    align-items: center;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .word-count-display.near-limit {
    background: linear-gradient(135deg, #ffcc66 0%, #ff7a66 100%);
    box-shadow: 0 2px 10px rgba(255, 122, 102, 0.35);
  }

  .word-count-display.over-limit {
    background: linear-gradient(135deg, #ff8a8a 0%, #ff4b4b 100%);
  }

  #limitNotice {
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: 8px;
    padding: 6px 10px;
    border-radius: 6px;
    background: rgba(255,255,255,0.12);
  }

  .mood-question {
    margin-bottom: 20px;
  }

  #emojiOptions {
    display: flex;
    gap: 20px;
    margin-top: 8px;
  }

  .emoji-option {
    font-size: 2rem;
    cursor: pointer;
    padding: 10px;
    border-radius: 10px;
    transition: all 0.25s ease;
    user-select: none;
  }

  .emoji-option:hover {
    transform: scale(1.15);
    background-color: #f3f4f6;
  }

  .emoji-selected {
    background-color: #e0e7ff;
    border: 2px solid #4e73df;
    transform: scale(1.2);
    box-shadow: 0 2px 6px rgba(78, 115, 223, 0.3);
  }

  /* New styles for warnings */
  .unsaved-warning, .validation-warning {
    display: none;
    color: #ff6b6b;
    font-size: 0.9em;
    margin-top: 10px;
    padding: 8px 12px;
    border: 1px solid #ff6b6b;
    background-color: #ffeaea;
    border-radius: 4px;
  }
  .unsaved-warning.show, .validation-warning.show {
    display: block;
  }
</style>
{% endblock %}

{% block content %}
<section class="edit-post">
  <div class="container">
    <div class="section-title">
      <h2>Edit {{ post_type|capfirst }} Post</h2>
      <p>Update your entry below.</p>
    </div>

    <div class="form-container">
      <form method="post" id="editPostForm">
        {% csrf_token %}

        {% if post_type == 'dailypost' %}
          <button type="button" id="mic-button"><i class="fas fa-microphone"></i> Start Voice Input</button>
          <div style="margin-bottom:10px">
            <textarea id="text" name="text">{{ post.text|safe }}</textarea>
          </div>
          <div class="word-count-display" id="wordCountContainer">
            <div class="count-item"><i class="fas fa-font"></i> Words: <strong id="wordCount">0 / 400</strong></div>
            <div class="count-item"><i class="fas fa-keyboard"></i> Chars: <strong id="charCount">0</strong></div>
            <div id="limitNotice" style="display:none"></div>
          </div>

        {% elif post_type == 'moodpost' %}
          <div class="mood-question">
            <label>1) What is your current mood?</label>
            <div id="emojiOptions">
              <span class="emoji-option {% if post.mood_emoji == 'happy' %}emoji-selected{% endif %}" data-value="happy">üòä</span>
              <span class="emoji-option {% if post.mood_emoji == 'neutral' %}emoji-selected{% endif %}" data-value="neutral">üòê</span>
              <span class="emoji-option {% if post.mood_emoji == 'sad' %}emoji-selected{% endif %}" data-value="sad">üòû</span>
            </div>
            <input type="hidden" name="mood_emoji" id="moodEmoji" value="{{ post.mood_emoji }}">
          </div>

          <div class="mood-question">
            <label>2) Energy level (1-5)</label>
            <input type="number" name="energy_level" min="1" max="5" class="form-control" value="{{ post.energy_level }}" required>
          </div>

          <div class="mood-question">
            <label>3) Did you work out today?</label>
            <select name="worked_out" class="form-control" required>
              <option value="True" {% if post.worked_out %}selected{% endif %}>Yes</option>
              <option value="False" {% if not post.worked_out %}selected{% endif %}>No</option>
            </select>
          </div>

          <div class="mood-question">
            <label>4) What triggered this mood?</label>
            <textarea name="mood_trigger" rows="3" class="form-control" required>{{ post.mood_trigger }}</textarea>
          </div>
        {% endif %}

        <p id="unsavedWarning" class="unsaved-warning">
          <i class="fas fa-exclamation-triangle"></i> You have unsaved changes.
        </p>

        <p id="validationWarning" class="validation-warning">
          <i class="fas fa-exclamation-circle"></i>
          <span id="validationMessage"></span>
        </p>

        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">
          <i class="fas fa-save"></i> Save Changes
        </button>
        <a href="{% url 'posts:list_posts' %}" class="btn btn-secondary" style="margin-left:10px;">Cancel</a>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
{{ form.media }}

<script>
// ======== Unsaved Changes Global Flag =========
let hasUnsavedChanges = false;
window.addEventListener('beforeunload', function(e) {
  if (hasUnsavedChanges) {
    e.preventDefault();
    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    return e.returnValue;
  }
});

// ======== Global CKEDITOR INSTANCE =========
let editorInstance = null;

// ====== Word limit config ======
const MAX_WORDS = 400;
const WARN_THRESHOLD = Math.floor(MAX_WORDS * 0.9); // 90% => 360

// ===== Helper: Show validation messages visually =====
function showValidationMessage(msg) {
  const warning = document.getElementById('validationWarning');
  const messageEl = document.getElementById('validationMessage');
  if (!warning || !messageEl) return;
  messageEl.textContent = msg;
  warning.classList.add('show');
  // auto-hide after 3s
  setTimeout(() => warning.classList.remove('show'), 3000);
}

// ===== Text helpers =====
function plainTextFromHtml(html) {
  if (!html) return '';
  return html
    .replace(/<[^>]*>/g, '')   // remove HTML tags
    .replace(/&nbsp;/g, ' ')   // handle CKEditor non-breaking spaces
    .replace(/\u200B/g, '')    // zero-width
    .trim();
}

function countWordsFromText(text) {
  if (!text) return 0;
  const wordsArray = text.split(/\s+/).filter(w => w.length > 0);
  return wordsArray.length;
}

function truncateToWords(text, max) {
  if (!text) return '';
  const words = text.split(/\s+/).filter(w => w.length > 0);
  if (words.length <= max) return words.join(' ');
  return words.slice(0, max).join(' ');
}

// ======== CKEditor Setup (with word limit enforcement) =========
function setupCKEditor(textareaId) {
  if (typeof CKEDITOR === 'undefined') {
    console.error('CKEDITOR object is undefined. Check asset loading.');
    return;
  }
  if (CKEDITOR.instances[textareaId]) CKEDITOR.instances[textareaId].destroy(true);

  CKEDITOR.replace(textareaId);

  CKEDITOR.instances[textareaId].on('instanceReady', function(evt) {
    editorInstance = evt.editor;

    const updateWordCount = () => {
      const content = editorInstance.getData();
      const textOnly = plainTextFromHtml(content);

      const chars = textOnly.replace(/[ \t\n\r]+/g, '').length;
      const words = countWordsFromText(textOnly);

      const wordCountEl = document.getElementById('wordCount');
      const charCountEl = document.getElementById('charCount');
      const wordContainer = document.querySelector('.word-count-display');
      const limitNotice = document.getElementById('limitNotice');

      if (wordCountEl) wordCountEl.textContent = `${words} / ${MAX_WORDS}`;
      if (charCountEl) charCountEl.textContent = chars;

      if (wordContainer) {
        if (words >= MAX_WORDS) {
          wordContainer.classList.remove('near-limit');
          wordContainer.classList.add('over-limit');
        } else if (words >= WARN_THRESHOLD) {
          wordContainer.classList.add('near-limit');
          wordContainer.classList.remove('over-limit');
        } else {
          wordContainer.classList.remove('near-limit', 'over-limit');
        }
      }

      if (limitNotice) {
        if (words >= WARN_THRESHOLD && words < MAX_WORDS) {
          limitNotice.textContent = `Approaching limit ‚Äî ${MAX_WORDS - words} words left`;
          limitNotice.style.display = 'inline-block';
        } else if (words >= MAX_WORDS) {
          limitNotice.textContent = `Word limit reached (${MAX_WORDS}) ‚Äî extra content was truncated.`;
          limitNotice.style.display = 'inline-block';
        } else {
          limitNotice.style.display = 'none';
        }
      }
    };

    // Initial count (do not mark as unsaved)
    updateWordCount();

    const handleUserChange = () => {
      // mark unsaved changes
      if (!hasUnsavedChanges) {
        hasUnsavedChanges = true;
        const unsaved = document.getElementById('unsavedWarning');
        if (unsaved) unsaved.classList.add('show');
      }
      // enforce limit then update
      enforceWordLimitInEditor();
      updateWordCount();
    };

    editorInstance.on('key', () => setTimeout(handleUserChange, 10));
    editorInstance.on('paste', () => setTimeout(handleUserChange, 100));
    editorInstance.on('change', handleUserChange);
  });
}

// ======== Enforce / Truncate in CKEditor if over limit ========
function enforceWordLimitInEditor() {
  if (!editorInstance) return;
  const data = editorInstance.getData();
  const txt = plainTextFromHtml(data);
  const words = countWordsFromText(txt);
  if (words <= MAX_WORDS) return;

  const truncated = truncateToWords(txt, MAX_WORDS);
  editorInstance.setData(truncated);
  editorInstance.focus();
}

// ======== Mic Button Setup (respects remaining allowance) =========
function setupMicButton() {
  const micButton = document.getElementById('mic-button');
  if (!micButton) return;

  if (window.SpeechRecognition || window.webkitSpeechRecognition) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = new SpeechRecognition();
    recognition.interimResults = false;
    recognition.continuous = false;
    recognition.lang = 'en-US';
    let isListening = false;

    recognition.onresult = (event) => {
      let finalTranscript = '';
      for (let i = event.resultIndex; i < event.results.length; i++)
        if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;

      if (finalTranscript && editorInstance) {
        const currentText = plainTextFromHtml(editorInstance.getData());
        const currentWords = countWordsFromText(currentText);
        const incomingWords = countWordsFromText(finalTranscript);
        const allowed = Math.max(0, MAX_WORDS - currentWords);

        if (allowed <= 0) {
          showValidationMessage('Word limit reached. Cannot insert more text.');
          return;
        }
        let toInsert = finalTranscript;
        if (incomingWords > allowed) {
          toInsert = truncateToWords(finalTranscript, allowed);
          editorInstance.insertHtml(toInsert + ' ');
          editorInstance.fire('change');
          showValidationMessage(`Inserted partial dictation ‚Äî reached ${MAX_WORDS} words.`);
        } else {
          editorInstance.insertHtml(finalTranscript + ' ');
          editorInstance.fire('change');
        }
      }
    };

    recognition.onstart = () => {
      micButton.textContent = 'Dictating... (Click to Stop)';
      micButton.classList.add('btn-listening');
      isListening = true;
    };

    recognition.onend = () => {
      micButton.innerHTML = '<i class="fas fa-microphone"></i> Start Voice Input';
      micButton.classList.remove('btn-listening');
      isListening = false;
    };

    micButton.addEventListener('click', () => {
      if (!editorInstance) return showValidationMessage("Editor not ready for voice input.");
      isListening ? recognition.stop() : recognition.start();
    });
  } else {
    micButton.style.display = 'none';
  }
}

document.addEventListener('DOMContentLoaded', function () {
  const postType = "{{ post_type|default:'' }}".toLowerCase();
  const editForm = document.getElementById('editPostForm');

  // ‚úÖ Mood Post emoji selector & unsaved tracking
  if (postType === "moodpost") {
    document.querySelectorAll('.emoji-option').forEach(el => {
      el.addEventListener('click', function() {
        document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('emoji-selected'));
        this.classList.add('emoji-selected');
        document.getElementById('moodEmoji').value = this.dataset.value;

        // Set unsaved changes flag
        hasUnsavedChanges = true;
        document.getElementById('unsavedWarning').classList.add('show');
      });
    });

    // Track changes on other input fields for moodpost
    editForm.querySelectorAll('.form-control, textarea').forEach(input => {
        input.addEventListener('change', function() {
            hasUnsavedChanges = true;
            document.getElementById('unsavedWarning').classList.add('show');
        });
        input.addEventListener('input', function() {
            hasUnsavedChanges = true;
            document.getElementById('unsavedWarning').classList.add('show');
        });
    });
  }

  // ‚úÖ Daily Post CKEditor + mic setup (with word limit)
  if (postType === "dailypost" && typeof CKEDITOR !== 'undefined') {
    setupCKEditor('text');
    setupMicButton();
  }

  // ======== Form Validation Before Submit (Unified) =========
  editForm.addEventListener('submit', function(e) {
    // Clear previous validation message
    const validationWarning = document.getElementById('validationWarning');
    if (validationWarning) validationWarning.classList.remove('show');

    if (postType === 'dailypost') {
      if (!editorInstance) {
        showValidationMessage('Editor not ready. Please wait a moment.');
        e.preventDefault();
        return;
      }

      const rawText = plainTextFromHtml(editorInstance.getData()).trim();
      const visibleChars = rawText.replace(/\s+/g, '');
      if (visibleChars.length === 0) {
        showValidationMessage('Your daily entry cannot be empty or only whitespace.');
        e.preventDefault();
        return;
      }

      const words = countWordsFromText(rawText);
      if (words > MAX_WORDS) {
        showValidationMessage(`Your post exceeds the ${MAX_WORDS}-word limit. Please shorten it.`);
        e.preventDefault();
        return;
      }
    }

    if (postType === 'moodpost') {
      const moodEmojiInput = document.getElementById('moodEmoji');
      if (!moodEmojiInput || moodEmojiInput.value.trim() === '') {
        showValidationMessage('Please select your current mood (emoji) before submitting.');
        e.preventDefault();
        return;
      }

      const energyEl = document.querySelector('[name="energy_level"]');
      const workedEl = document.querySelector('[name="worked_out"]');
      const triggerEl = document.querySelector('[name="mood_trigger"]');

      if (!energyEl || !energyEl.value || energyEl.value < 1 || energyEl.value > 5) {
        showValidationMessage('Please enter a valid energy level (1-5).');
        e.preventDefault();
        return;
      }
      if (!workedEl || workedEl.value.trim() === '') {
        showValidationMessage('Please indicate whether you worked out today.');
        e.preventDefault();
        return;
      }
      if (!triggerEl || triggerEl.value.trim().length === 0) {
        showValidationMessage('Please describe what triggered this mood.');
        e.preventDefault();
        return;
      }
    }

    // Passed validation: clear unsaved flag
    hasUnsavedChanges = false;
  });

  // Small safety: periodic enforce
  setInterval(() => {
    if (editorInstance) enforceWordLimitInEditor();
  }, 1500);
});
</script>
{% endblock %}
